#!/bin/bash
# Aerospike Service Setup Script

echo "ğŸš€ Setting up Aerospike Service gem repository"

# Get Ruby version from .ruby-version file
RUBY_VERSION=$(cat .ruby-version | tr -d '\n')
echo "ğŸ” Detected Ruby version: $RUBY_VERSION"

# Clean up previous installation
echo "ğŸ§¹ Cleaning up previous bundle installation..."
rm -rf .bundle
rm -rf vendor/bundle
[ -f Gemfile.lock ] && rm Gemfile.lock
bundle clean --force 2>/dev/null || true

# Setup bundler paths
echo "ğŸ”§ Configuring bundler..."
mkdir -p .bundle
mkdir -p vendor/bundle
bundle config set --local path 'vendor/bundle'
# Ensure we're using the correct Ruby version
bundle config set --local ruby-version $RUBY_VERSION
bundle config set --local force_ruby_platform true

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
bundle install

# Create test directories if they don't exist
echo "ğŸ“ Setting up test environment..."
mkdir -p spec/config

# Copy configuration template if it doesn't exist
if [ ! -f spec/config/aerospike_service.yml ]; then
  echo "ğŸ“„ Creating test configuration..."
  cp lib/aerospike_service/templates/aerospike_service.yml spec/config/
fi

echo ""
echo "âœ¨ Setup complete! âœ¨"
echo ""
echo "ğŸ§ª To run tests: bundle exec rspec"
echo "ğŸ” To start console: bin/console"
echo "ğŸ“š Read documentation: bundle exec yard server"
echo ""
echo "Happy coding! ğŸ‰"