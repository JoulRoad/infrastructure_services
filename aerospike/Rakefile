# frozen_string_literal: true

require "bundler/gem_tasks"
require "rspec/core/rake_task"
require "rubocop/rake_task"
require "yard"
require "fileutils"

# Setup tasks
namespace :setup do
  desc "Ensure all dependencies are installed"
  task :dependencies do
    puts "Checking dependencies..."
    system("bundle check") || system("bundle install")
  end

  desc "Ensure test directories exist"
  task :test_dirs do
    %w[spec/aerospike_service spec/integration].each do |dir|
      FileUtils.mkdir_p(dir) unless File.directory?(dir)
    end
  end

  desc "Complete setup"
  task all: [:dependencies, :test_dirs]
end

# Testing tasks
namespace :test do
  desc "Run unit tests"
  RSpec::Core::RakeTask.new(:unit) do |t|
    t.pattern = "spec/aerospike_service/**/*_spec.rb"
  end

  desc "Run integration tests"
  RSpec::Core::RakeTask.new(:integration) do |t|
    t.pattern = "spec/integration/**/*_spec.rb"
  end

  desc "Run all tests"
  RSpec::Core::RakeTask.new(:all)

  desc "Run tests with coverage report"
  task :coverage do
    ENV["COVERAGE"] = "true"
    Rake::Task["test:all"].invoke
  end

  # Make the standard :spec task invoke our test:all
  task :spec do
    Rake::Task["test:all"].invoke
  end
end

# Linting tasks
namespace :lint do
  desc "Run RuboCop"
  RuboCop::RakeTask.new(:rubocop)

  desc "Run all linters"
  task all: [:rubocop]
end

# Documentation tasks
namespace :doc do
  desc "Generate YARD documentation"
  YARD::Rake::YardocTask.new(:generate)

  desc "Generate documentation and open in browser"
  task open: :generate do
    sh "open doc/index.html"
  end

  desc "Check documentation coverage"
  task coverage: :generate do
    sh "yard stats --list-undoc"
  end
end

# Utility tasks
namespace :util do
  desc "Run console"
  task console: "setup:dependencies" do
    sh "bin/console"
  end

  desc "Clean generated files"
  task :clean do
    dirs = %w[coverage doc pkg .yardoc]
    dirs.each { |dir| FileUtils.rm_rf(dir) }
  end
end

# Define task prerequisites
task spec: ["setup:test_dirs"]

# Default task - runs everything needed for CI
desc "Run complete test suite (tests, linting, docs)"
task default: ["setup:all", "test:all", "lint:all", "doc:generate"]

# Convenience aliases for common tasks
task test: "test:all"
task unit: "test:unit"
task integration: "test:integration"
task lint: "lint:all"
task console: "util:console"
task clean: "util:clean"
